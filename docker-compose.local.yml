version: '3.8'

# Local testing version - uses local directories instead of SMB
# Usage: docker-compose -f docker-compose.local.yml --env-file .env.local up

networks:
  ai-services:
    driver: bridge

volumes:
  comfyui-data:
  invokeai-data:
  dockge-data:
  dockge-stacks:

services:
  # ============================================
  # ComfyUI - Node-based AI Image Generation
  # ============================================
  comfyui:
    image: yanwk/comfyui-boot:cu128-megapak-pt28
    container_name: dhoch3-comfyui
    restart: unless-stopped
    networks:
      - ai-services
    ports:
      - "${COMFYUI_PORT:-8188}:8188"
    volumes:
      - ${MODELS_PATH:-./test-models}:/models:ro
      - ./test-outputs/ComfyUI:/output
      - comfyui-data:/home/runner
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ============================================
  # Fooocus - AI Image Generation
  # ============================================
  fooocus:
    build:
      context: ./dockerfiles/fooocus
      dockerfile: Dockerfile
    image: dhoch3/fooocus:latest
    container_name: dhoch3-fooocus
    restart: unless-stopped
    networks:
      - ai-services
    ports:
      - "${FOOOCUS_PORT:-7860}:7860"
    volumes:
      - ${MODELS_PATH:-./test-models}:/models:ro
      - ./test-outputs/Fooocus:/outputs
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ============================================
  # Forge - Stable Diffusion WebUI
  # ============================================
  forge:
    build:
      context: ./dockerfiles/forge
      dockerfile: Dockerfile
    image: dhoch3/forge:latest
    container_name: dhoch3-forge
    restart: unless-stopped
    networks:
      - ai-services
    ports:
      - "${FORGE_PORT:-7861}:7861"
    volumes:
      - ${MODELS_PATH:-./test-models}:/models:ro
      - ./test-outputs/Forge:/outputs
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - COMMANDLINE_ARGS=--listen --port 7861 --xformers --api --enable-insecure-extension-access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ============================================
  # InvokeAI - Professional AI Image Generation
  # ============================================
  invokeai:
    image: ghcr.io/invoke-ai/invokeai:latest
    container_name: dhoch3-invokeai
    restart: unless-stopped
    networks:
      - ai-services
    ports:
      - "${INVOKEAI_PORT:-9090}:9090"
    volumes:
      - ${MODELS_PATH:-./test-models}:/models:ro
      - ./test-outputs/InvokeAI:/outputs
      - invokeai-data:/invokeai
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - INVOKEAI_ROOT=/invokeai
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ============================================
  # Dockge - Container Management UI
  # ============================================
  dockge:
    image: louislam/dockge:latest
    container_name: dhoch3-dockge
    restart: unless-stopped
    networks:
      - ai-services
    ports:
      - "${DOCKGE_PORT:-5001}:5001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - dockge-data:/app/data
      - dockge-stacks:/opt/stacks
      - .:/opt/stacks/dhoch3-ai-services
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks

