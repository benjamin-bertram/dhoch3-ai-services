version: "3.8"
networks:
  ai-services:
    driver: bridge
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik_default}
volumes:
  comfyui-data: null
  invokeai-data: null
  dockge-data: null
  dockge-stacks: null
services:
  # ============================================
  # ComfyUI - AI Image Generation
  # ============================================
  comfyui:
    image: ${COMFYUI_IMAGE:-yanwenkunwork/comfyui-docker:cu128-megapak-pt28}
    container_name: dhoch3-comfyui
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${COMFYUI_PORT:-8188}:8188
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # Service data
      - comfyui-data:/app/ComfyUI
      # User outputs
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/ComfyUI
        target: /outputs
      # User inputs (optional)
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input
        target: /inputs:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.comfyui.entrypoints=websecure
      - traefik.http.routers.comfyui.rule=Host(`${COMFYUI_SUBDOMAIN:-comfyui}.${DOMAIN}`)
      - traefik.http.routers.comfyui.tls=true
      - traefik.http.routers.comfyui.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.comfyui.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.comfyui.loadbalancer.server.port=8188
  # ============================================
  # Fooocus - AI Image Generation
  # ============================================
  fooocus:
    build:
      context: ./dockerfiles/fooocus
      dockerfile: Dockerfile
    image: dhoch3/fooocus:latest
    container_name: dhoch3-fooocus
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${FOOOCUS_PORT:-7860}:7860
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # User outputs
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/Fooocus
        target: /outputs
      # User inputs (optional)
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input
        target: /inputs:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.fooocus.entrypoints=websecure
      - traefik.http.routers.fooocus.rule=Host(`${FOOOCUS_SUBDOMAIN:-fooocus}.${DOMAIN}`)
      - traefik.http.routers.fooocus.tls=true
      - traefik.http.routers.fooocus.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.fooocus.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.fooocus.loadbalancer.server.port=7860
  # ============================================
  # Forge - Stable Diffusion WebUI
  # ============================================
  forge:
    build:
      context: ./dockerfiles/forge
      dockerfile: Dockerfile
    image: dhoch3/forge:latest
    container_name: dhoch3-forge
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${FORGE_PORT:-7861}:7861
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # User outputs
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/Forge
        target: /outputs
      # User inputs (optional)
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input
        target: /inputs:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.forge.entrypoints=websecure
      - traefik.http.routers.forge.rule=Host(`${FORGE_SUBDOMAIN:-forge}.${DOMAIN}`)
      - traefik.http.routers.forge.tls=true
      - traefik.http.routers.forge.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.forge.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.forge.loadbalancer.server.port=7861
  # ============================================
  # InvokeAI - AI Image Generation
  # ============================================
  invokeai:
    image: ${INVOKEAI_IMAGE:-ghcr.io/invoke-ai/invokeai:latest}
    container_name: dhoch3-invokeai
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${INVOKEAI_PORT:-9090}:9090
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # Service data
      - invokeai-data:/invokeai
      # User outputs
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/InvokeAI
        target: /outputs
      # User inputs (optional)
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input
        target: /inputs:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.invokeai.entrypoints=websecure
      - traefik.http.routers.invokeai.rule=Host(`${INVOKEAI_SUBDOMAIN:-invokeai}.${DOMAIN}`)
      - traefik.http.routers.invokeai.tls=true
      - traefik.http.routers.invokeai.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.invokeai.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.invokeai.loadbalancer.server.port=9090
  # ============================================
  # FluxGym - Flux LoRA Training
  # ============================================
  fluxgym:
    build:
      context: ./dockerfiles/fluxgym
      dockerfile: Dockerfile
    image: dhoch3/fluxgym:latest
    container_name: dhoch3-fluxgym
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${FLUXGYM_PORT:-3000}:3000
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # Training outputs (LoRAs, checkpoints)
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/FluxGym
        target: /outputs
      # Training datasets
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input/datasets
        target: /datasets:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.fluxgym.entrypoints=websecure
      - traefik.http.routers.fluxgym.rule=Host(`${FLUXGYM_SUBDOMAIN:-fluxgym}.${DOMAIN}`)
      - traefik.http.routers.fluxgym.tls=true
      - traefik.http.routers.fluxgym.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.fluxgym.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.fluxgym.loadbalancer.server.port=3000
  # ============================================
  # AI Toolkit - AI Training Tools
  # ============================================
  ai-toolkit:
    build:
      context: ./dockerfiles/ai-toolkit
      dockerfile: Dockerfile
    image: dhoch3/ai-toolkit:latest
    container_name: dhoch3-ai-toolkit
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${AI_TOOLKIT_PORT:-8080}:8080
    volumes:
      # Shared models (read-only)
      - ${MODELS_PATH}:/models:ro
      # Training outputs
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/output/AIToolkit
        target: /outputs
      # Training datasets
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage-user/input/datasets
        target: /datasets:ro
      # Configuration files
      - type: bind
        source: //${SMB_SERVER}/${SMB_SHARE}/storage/AIToolkit/config
        target: /config
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.ai-toolkit.entrypoints=websecure
      - traefik.http.routers.ai-toolkit.rule=Host(`${AI_TOOLKIT_SUBDOMAIN:-ai-toolkit}.${DOMAIN}`)
      - traefik.http.routers.ai-toolkit.tls=true
      - traefik.http.routers.ai-toolkit.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.ai-toolkit.middlewares=${TRAEFIK_MIDDLEWARE:-default@file}
      - traefik.http.services.ai-toolkit.loadbalancer.server.port=8080
  # ============================================
  # Dockge - Container Management UI
  # ============================================
  dockge:
    image: ${DOCKGE_IMAGE:-louislam/dockge:latest}
    container_name: dhoch3-dockge
    restart: unless-stopped
    networks:
      - traefik
      - ai-services
    ports:
      - ${DOCKGE_PORT:-5001}:5001
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - dockge-data:/app/data
      - dockge-stacks:/opt/stacks
      - ${PWD}:/opt/stacks/dhoch3-ai-services
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_default}
      # HTTP Router
      - traefik.http.routers.dockge.entrypoints=websecure
      - traefik.http.routers.dockge.rule=Host(`${DOCKGE_SUBDOMAIN:-dockge}.${DOMAIN}`)
      - traefik.http.routers.dockge.tls=true
      - traefik.http.routers.dockge.tls.certresolver=${CERT_RESOLVER:-letsencryptresolver}
      - traefik.http.routers.dockge.middlewares=${TRAEFIK_MIDDLEWARE:-admin-auth@file,default@file}
      - traefik.http.routers.dockge.priority=1000
      - traefik.http.services.dockge.loadbalancer.server.port=5001
